<script type="text/javascript">

  function enter(e) {
    return true;
  }

  function over(e) {
    var pbi = e.dataTransfer.getData('pbi');
    var id = e.target.getAttribute('id');

    // return false para permitir soltar
    return false;
  }

  function drop(e) {
    var pbi_id = e.dataTransfer.getData('pbi');
    e.target.appendChild(document.getElementById(pbi_id));
    e.stopPropagation();
    return false;
  }

  function start(e) {
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('pbi', e.target.getAttribute('id'));
    e.dataTransfer.setDragImage(e.target, 0, 0);
    return true;
  }

  function end(e) {
    e.dataTransfer.clearData('pbi');
    return true;
  }

  function PBI() {
    var pbi = document.createElement('div');
    var product_backlog = document.getElementById('product-backlog');
    pbi.className = 'pbi';
    //pbi.addEventListener('focusLost', function(e) {return self.onFocusLost(e);});
    product_backlog.appendChild(pbi);
  }

  PBI.prototype = {
    get id() {
      if (!("_id" in this))
        this._id = 0;
      return this._id;
    },

    set id(x) {
      this._id = x
    },

    get description() {
      return this.innerHTML;
    },

    set description(x) {
      this.innerHTML = x;
    }

  }

  function addPBI() {
    var pbi = new PBI();
  }

  function submitWithAjax(id, description) {  

    $.ajax({
      type: "POST",
      url: "<%=update_pbi_path%>",
      data: "pbi_id=" + id + "&description=" + description,
      success: function(msg){
        
      }
    });

  }

  function update_pbi(e) {

    var form = $("#hidden_form");
    var input_pbi_id = $("#pbi_id");
    var input_description = $("#description");
    var pbi = e.parentNode;

    input_pbi_id.value = e.parentNode.id;
    input_description.value = e.innerHTML;

    // make it draggable
    e.setAttribute('contenteditable','false');
    pbi.setAttribute('draggable','true');

    submitWithAjax(input_pbi_id.value, input_description.value);
  }

  function edit_pbi(e) {
    var pbi_header = e.parentNode;
    var pbi = pbi_header.parentNode;
    var divs = pbi.getElementsByTagName('div');
    var pbi_description = divs[1];
    
    pbi_description.setAttribute('contenteditable','true');
    pbi.setAttribute('draggable','false');
    pbi_description.focus();
  }

  // Capturing tab event
  $(".pbi-description").live('keydown', function(e) {
    var keyCode = e.keyCode || e.which;

    // Tab event 
    if (keyCode == 9) {
      update_pbi(this);
    }
  });

</script>

<%= link_to 'Add', create_pbi_path, remote: true %>
<div id="product-backlog" 
  ondragenter="return enter(event)"
  ondragover="return over(event)"
  ondrop="return drop(event)">
  <%= render 'sprint/partials/product_backlog' %>
</div>
<div id="sprint"
  ondragenter="return enter(event)"
  ondragover="return over(event)"
  ondrop="return drop(event)">
  
</div>

<%= form_tag update_pbi_path, :id => 'hidden_form', :remote => true do %>
  <input type="hidden" id="pbi_id" value="" name="pbi_id">
  <input type="hidden" id="description" value="" name="description">
<% end %>

